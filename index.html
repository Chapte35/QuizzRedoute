<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz des Capitales</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #fff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin: 0.5rem;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }

        .btn.success {
            background: linear-gradient(45deg, #00b894, #00a085);
        }

        .btn.debug {
            background: linear-gradient(45deg, #6c5ce7, #5f3dc4);
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
        }

        .input-group {
            margin: 1rem 0;
        }

        input[type="text"] {
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            width: 100%;
            max-width: 300px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .qr-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            display: inline-block;
        }

        .game-id {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
        }

        .players-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .question-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .question-text {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 2rem 0;
        }

        .option-btn {
            padding: 1rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .option-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .option-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .option-btn.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.3);
        }

        .option-btn.correct {
            background: rgba(0, 184, 148, 0.8);
            border-color: #00b894;
        }

        .option-btn.incorrect {
            background: rgba(255, 107, 107, 0.8);
            border-color: #ff6b6b;
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            margin: 1rem 0;
        }

        .score-board {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .debug-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .mobile-warning {
            display: none;
            background: rgba(255, 193, 7, 0.8);
            color: #333;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                margin: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .host-screen .mobile-warning {
                display: block;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .success {
            background: rgba(39, 174, 96, 0.8);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Quiz des Capitales</h1>

        <!-- √âcran d'accueil -->
        <div id="homeScreen" class="screen active">
            <p style="font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9;">
                Testez vos connaissances g√©ographiques avec vos amis !
            </p>
            <button class="btn" onclick="showCreateGame()">üéÆ Cr√©er une partie</button>
            <button class="btn secondary" onclick="showJoinGame()">üì± Rejoindre une partie</button>
        </div>

        <!-- √âcran de cr√©ation de partie -->
        <div id="createGameScreen" class="screen">
            <h2>Cr√©er une nouvelle partie</h2>
            <div class="mobile-warning">
                ‚ö†Ô∏è Pour une meilleure exp√©rience, utilisez un ordinateur comme h√¥te et les t√©l√©phones pour jouer.
            </div>
            <button class="btn success" onclick="createGame()">
                <span id="createGameText">üöÄ Cr√©er la partie</span>
                <span id="createGameLoading" class="loading" style="display: none;"></span>
            </button>
            <button class="btn secondary" onclick="showHome()">‚Ü©Ô∏è Retour</button>
        </div>

        <!-- √âcran de rejoindre une partie -->
        <div id="joinGameScreen" class="screen">
            <h2>Rejoindre une partie</h2>
            <div class="input-group">
                <input type="text" id="gameIdInput" placeholder="Code de la partie" maxlength="6" style="text-transform: uppercase;">
                <div style="margin-top: 1rem;">
                    <input type="text" id="playerNameInput" placeholder="Votre nom" maxlength="20">
                </div>
            </div>
            <button class="btn success" onclick="joinGame()">
                <span id="joinGameText">üéØ Rejoindre</span>
                <span id="joinGameLoading" class="loading" style="display: none;"></span>
            </button>
            <button class="btn secondary" onclick="showHome()">‚Ü©Ô∏è Retour</button>
            <div id="joinError" class="error" style="display: none;"></div>
        </div>

        <!-- √âcran h√¥te - Attente des joueurs -->
        <div id="hostWaitingScreen" class="screen">
            <h2>üéÆ Partie cr√©√©e !</h2>
            <div class="game-id">
                Code de la partie : <span id="gameIdDisplay"></span>
            </div>
            <div class="qr-container">
                <div id="qrcode">
                    <div style="padding: 20px; color: #666;">
                        G√©n√©ration du QR code...
                    </div>
                </div>
            </div>
            <p>Scannez le QR code ou entrez le code de la partie sur votre t√©l√©phone</p>
            
            <div class="players-list">
                <h3>üèÜ Joueurs connect√©s :</h3>
                <div id="playersList">
                    <p style="opacity: 0.7;">En attente des joueurs...</p>
                </div>
            </div>
            
            <button class="btn success" onclick="startGame()" id="startGameBtn" disabled>
                ‚ö° Commencer la partie
            </button>
            <button class="btn secondary" onclick="endGameSession()">üö™ Quitter</button>
            <button class="btn debug" onclick="debugGameState()">üîç Debug</button>
        </div>

        <!-- √âcran h√¥te - Question en cours -->
        <div id="hostQuestionScreen" class="screen">
            <div class="question-container">
                <div class="timer" id="hostTimer">30</div>
                <div class="question-text" id="hostQuestionText"></div>
                <div class="options-grid" id="hostOptionsGrid"></div>
            </div>
            <div id="hostAnswersCount">En attente des r√©ponses...</div>
            <div style="margin: 1rem 0;">
                <button class="btn secondary" onclick="skipQuestion()">‚è≠Ô∏è Passer</button>
                <button class="btn debug" onclick="debugGameState()">üîç Debug</button>
                <button class="btn debug" onclick="forceNextQuestion()">üöÄ Forcer suite</button>
            </div>
        </div>

        <!-- √âcran h√¥te - R√©sultats -->
        <div id="hostResultsScreen" class="screen">
            <h2>üìä R√©sultats de la question</h2>
            <div id="hostCorrectAnswer"></div>
            <div class="score-board" id="hostScoreBoard"></div>
            <div id="hostNextQuestionInfo">Question suivante dans <span id="hostNextTimer">5</span> secondes...</div>
            <button class="btn debug" onclick="debugGameState()">üîç Debug</button>
        </div>

        <!-- √âcran h√¥te - R√©sultats finaux -->
        <div id="hostFinalScreen" class="screen">
            <h2>üèÜ Classement final</h2>
            <div class="score-board" id="hostFinalScoreBoard"></div>
            <button class="btn success" onclick="createGame()">üîÑ Nouvelle partie</button>
            <button class="btn secondary" onclick="showHome()">üè† Accueil</button>
        </div>

        <!-- √âcran joueur - Attente -->
        <div id="playerWaitingScreen" class="screen">
            <h2>‚úÖ Connect√© !</h2>
            <p>Vous √™tes connect√© √† la partie <strong id="playerGameId"></strong></p>
            <p>En attente du d√©marrage de la partie...</p>
            <div class="loading"></div>
        </div>

        <!-- √âcran joueur - Question -->
        <div id="playerQuestionScreen" class="screen">
            <div class="question-container">
                <div class="timer" id="playerTimer">30</div>
                <div class="question-text" id="playerQuestionText"></div>
                <div class="options-grid" id="playerOptionsGrid"></div>
            </div>
            <div id="playerSelectedAnswer" style="display: none;">
                ‚úÖ R√©ponse envoy√©e ! En attente des autres joueurs...
            </div>
        </div>

        <!-- √âcran joueur - R√©sultats -->
        <div id="playerResultsScreen" class="screen">
            <h2>üìä R√©sultat</h2>
            <div id="playerAnswerResult"></div>
            <div id="playerCurrentScore"></div>
            <div id="playerNextQuestionInfo">Question suivante dans <span id="playerNextTimer">5</span> secondes...</div>
        </div>

        <!-- √âcran joueur - R√©sultats finaux -->
        <div id="playerFinalScreen" class="screen">
            <h2>üèÅ Fin de la partie</h2>
            <div id="playerFinalResult"></div>
            <div class="score-board" id="playerFinalScoreBoard"></div>
            <button class="btn secondary" onclick="showHome()">üè† Nouvelle partie</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Configuration Firebase avec vos vraies informations
        const firebaseConfig = {
            apiKey: "AIzaSyANRVNNOYHP6959ujOl0694G2pz-Vb_Hwk",
            authDomain: "quizzcapitales-76ee3.firebaseapp.com",
            databaseURL: "https://quizzcapitales-76ee3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "quizzcapitales-76ee3",
            storageBucket: "quizzcapitales-76ee3.firebasestorage.app",
            messagingSenderId: "222950845814",
            appId: "1:222950845814:web:b4715f2476600675e95e57"
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variables globales
        let currentGameId = null;
        let currentPlayerId = null;
        let isHost = false;
        let questions = [];
        let timer = null;
        let timeLeft = 30;
        let questionListeners = [];

        // Chargement des questions
        async function loadQuestions() {
            try {
                const response = await fetch('./questions.json');
                const data = await response.json();
                questions = data.questions;
                console.log('‚úÖ Questions charg√©es:', questions.length);
                return questions;
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des questions:', error);
                showError('Erreur lors du chargement des questions');
                return [];
            }
        }

        // Navigation entre les √©crans
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            console.log('üì∫ √âcran affich√©:', screenId);
        }

        function showHome() {
            showScreen('homeScreen');
            cleanupGame();
        }

        function showCreateGame() {
            showScreen('createGameScreen');
        }

        function showJoinGame() {
            showScreen('joinGameScreen');
        }

        // Cr√©ation d'une partie (h√¥te)
        async function createGame() {
            console.log('üöÄ D√©but cr√©ation partie...');
            showLoading('createGameLoading', 'createGameText');
            
            try {
                await loadQuestions();
                if (questions.length === 0) {
                    throw new Error('Aucune question trouv√©e');
                }

                currentGameId = generateGameId();
                isHost = true;
                console.log('üîë Game ID g√©n√©r√©:', currentGameId);

                const gameData = {
                    id: currentGameId,
                    players: {},
                    currentQuestion: null,
                    currentQuestionIndex: 0,
                    gameState: 'waiting',
                    questions: questions,
                    createdAt: Date.now()
                };

                console.log('üíæ Sauvegarde en cours...');
                await database.ref(`games/${currentGameId}`).set(gameData);
                console.log('‚úÖ Partie cr√©√©e avec succ√®s !');
                
                document.getElementById('gameIdDisplay').textContent = currentGameId;
                generateQRCode();
                setupHostListeners();
                showScreen('hostWaitingScreen');
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la cr√©ation de la partie:', error);
                showError('Erreur lors de la cr√©ation de la partie: ' + error.message);
            } finally {
                hideLoading('createGameLoading', 'createGameText');
            }
        }

        // Rejoindre une partie (joueur)
        async function joinGame() {
            const gameId = document.getElementById('gameIdInput').value.trim().toUpperCase();
            const playerName = document.getElementById('playerNameInput').value.trim();

            if (!gameId || !playerName) {
                showJoinError('Veuillez entrer le code de la partie et votre nom');
                return;
            }

            console.log('üéØ Tentative de connexion:', gameId, playerName);
            showLoading('joinGameLoading', 'joinGameText');

            try {
                // V√©rifier si la partie existe
                const gameSnapshot = await database.ref(`games/${gameId}`).once('value');
                if (!gameSnapshot.exists()) {
                    throw new Error('Partie introuvable');
                }

                const gameData = gameSnapshot.val();
                if (gameData.gameState !== 'waiting') {
                    throw new Error('La partie a d√©j√† commenc√©');
                }

                currentGameId = gameId;
                currentPlayerId = generatePlayerId();
                isHost = false;

                console.log('üë§ Player ID g√©n√©r√©:', currentPlayerId);

                const playerData = {
                    id: currentPlayerId,
                    name: playerName,
                    score: 0,
                    answers: {},
                    joinedAt: Date.now()
                };

                await database.ref(`games/${gameId}/players/${currentPlayerId}`).set(playerData);
                console.log('‚úÖ Joueur connect√© avec succ√®s !');
                
                document.getElementById('playerGameId').textContent = gameId;
                setupPlayerListeners();
                showScreen('playerWaitingScreen');
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la connexion:', error);
                showJoinError(error.message || 'Erreur lors de la connexion');
            } finally {
                hideLoading('joinGameLoading', 'joinGameText');
            }
        }

        // G√©n√©ration d'ID uniques
        function generateGameId() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function generatePlayerId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // G√©n√©ration du QR Code avec plusieurs fallbacks
        function generateQRCode() {
            const gameUrl = `${window.location.origin}${window.location.pathname}?game=${currentGameId}`;
            
            console.log('üîó G√©n√©ration QR Code pour:', gameUrl);
            
            const qrContainer = document.getElementById('qrcode');
            
            if (!qrContainer) {
                console.error('‚ùå √âl√©ment qrcode introuvable !');
                return;
            }
            
            // Essayer plusieurs APIs de QR Code
            const qrApis = [
                `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(gameUrl)}`,
                `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(gameUrl)}`,
                `https://quickchart.io/qr?text=${encodeURIComponent(gameUrl)}&size=200`
            ];
            
            let currentApiIndex = 0;
            
            function tryNextApi() {
                if (currentApiIndex >= qrApis.length) {
                    // Toutes les APIs ont √©chou√©, afficher le lien direct
                    showDirectLink();
                    return;
                }
                
                const qrUrl = qrApis[currentApiIndex];
                console.log(`üîÑ Tentative API ${currentApiIndex + 1}:`, qrUrl);
                
                qrContainer.innerHTML = `
                    <div style="text-align: center;">
                        <img src="${qrUrl}" 
                             alt="QR Code pour rejoindre la partie" 
                             style="width: 200px; height: 200px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"
                             onload="console.log('‚úÖ QR Code charg√© avec l\\'API ${currentApiIndex + 1}')"
                             onerror="console.warn('‚ùå API ${currentApiIndex + 1} √©chou√©e, tentative suivante...'); tryNextApi();">
                        <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                            üì± Scannez avec votre t√©l√©phone
                        </div>
                    </div>
                `;
                
                currentApiIndex++;
            }
            
            function showDirectLink() {
                console.log('üîó Affichage du lien direct en fallback');
                qrContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; color: #333;">
                        <div style="font-size: 1.1rem; margin-bottom: 15px; color: #666;">
                            üì± <strong>QR Code indisponible</strong>
                        </div>
                        <div style="margin-bottom: 15px; font-weight: 600;">
                            üîó Lien direct :
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 10px 0; word-break: break-all; font-family: monospace; font-size: 0.85rem; border: 2px dashed #ddd;">
                            ${gameUrl}
                        </div>
                        <div style="font-size: 0.8rem; color: #666; line-height: 1.4;">
                            üìã <strong>Instructions :</strong><br>
                            1. Copiez le lien ci-dessus<br>
                            2. Ouvrez-le sur votre t√©l√©phone<br>
                            3. Ou envoyez-le √† vos amis par message
                        </div>
                        <button onclick="copyToClipboard('${gameUrl}')" 
                                style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üìã Copier le lien
                        </button>
                    </div>
                `;
            }
            
            // Commencer par la premi√®re API
            tryNextApi();
        }
        
        // Fonction pour copier dans le presse-papier
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('‚úÖ Lien copi√© !', 'success');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('‚úÖ Lien copi√© !', 'success');
            } catch (err) {
                showNotification('‚ùå Impossible de copier automatiquement', 'error');
            }
            
            document.body.removeChild(textArea);
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
                ${type === 'success' ? 'background: linear-gradient(135deg, #00b894, #00a085);' : 
                  type === 'error' ? 'background: linear-gradient(135deg, #e74c3c, #c0392b);' : 
                  'background: linear-gradient(135deg, #3498db, #2980b9);'}
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Configuration des √©couteurs pour l'h√¥te
        function setupHostListeners() {
            console.log('üéß Configuration des √©couteurs h√¥te pour:', currentGameId);
            
            // √âcouter les nouveaux joueurs
            database.ref(`games/${currentGameId}/players`).on('value', (snapshot) => {
                const players = snapshot.val() || {};
                console.log('üë• Mise √† jour joueurs:', Object.keys(players).length, 'joueurs');
                updatePlayersList(players);
                
                // Activer le bouton start si au moins un joueur
                const startBtn = document.getElementById('startGameBtn');
                if (Object.keys(players).length > 0) {
                    startBtn.disabled = false;
                    startBtn.textContent = `‚ö° Commencer (${Object.keys(players).length} joueur${Object.keys(players).length > 1 ? 's' : ''})`;
                } else {
                    startBtn.disabled = true;
                    startBtn.textContent = '‚ö° Commencer la partie';
                }
            });
        }

        // Configuration des √©couteurs pour les joueurs
        function setupPlayerListeners() {
            console.log('üéß Configuration des √©couteurs joueur pour:', currentGameId);
            
            // √âcouter les changements d'√©tat du jeu
            database.ref(`games/${currentGameId}/gameState`).on('value', (snapshot) => {
                const gameState = snapshot.val();
                console.log('üéÆ √âtat du jeu chang√©:', gameState);
                handleGameStateChange(gameState);
            });

            // √âcouter la question actuelle
            database.ref(`games/${currentGameId}/currentQuestion`).on('value', (snapshot) => {
                const question = snapshot.val();
                if (question && !isHost) {
                    console.log('üìù Nouvelle question re√ßue:', question.id);
                    displayPlayerQuestion(question);
                }
            });

            // √âcouter l'index de la question actuelle
            database.ref(`games/${currentGameId}/currentQuestionIndex`).on('value', (snapshot) => {
                const index = snapshot.val();
                if (index !== null && !isHost) {
                    console.log('üìä Index question:', index);
                }
            });
        }

        // Gestion des changements d'√©tat du jeu
        function handleGameStateChange(gameState) {
            if (isHost) {
                switch (gameState) {
                    case 'question':
                        showHostQuestion();
                        break;
                    case 'results':
                        showHostResults();
                        break;
                    case 'finished':
                        showHostFinalResults();
                        break;
                }
            } else {
                switch (gameState) {
                    case 'waiting':
                        showScreen('playerWaitingScreen');
                        break;
                    case 'question':
                        showScreen('playerQuestionScreen');
                        break;
                    case 'results':
                        showPlayerResults();
                        break;
                    case 'finished':
                        showPlayerFinalResults();
                        break;
                }
            }
        }

        // D√©marrer la partie (h√¥te)
        async function startGame() {
            console.log('üöÄ D√©marrage de la partie...');
            try {
                await database.ref(`games/${currentGameId}/gameState`).set('question');
                await database.ref(`games/${currentGameId}/currentQuestionIndex`).set(0);
                await showNextQuestion();
                console.log('‚úÖ Partie d√©marr√©e !');
            } catch (error) {
                console.error('‚ùå Erreur lors du d√©marrage:', error);
                showError('Erreur lors du d√©marrage de la partie');
            }
        }

        // Afficher la question suivante (h√¥te)
        async function showNextQuestion() {
            console.log('üìù Affichage de la question suivante...');
            const questionIndex = await database.ref(`games/${currentGameId}/currentQuestionIndex`).once('value');
            const currentIndex = questionIndex.val() || 0;

            if (currentIndex >= questions.length) {
                console.log('üèÅ Fin des questions, affichage des r√©sultats finaux');
                await database.ref(`games/${currentGameId}/gameState`).set('finished');
                return;
            }

            const question = questions[currentIndex];
            console.log('üìä Question actuelle:', currentIndex + 1, '/', questions.length);
            await database.ref(`games/${currentGameId}/currentQuestion`).set(question);
            
            showHostQuestion();
            startTimer();
        }

        // Afficher la question c√¥t√© h√¥te
        function showHostQuestion() {
            console.log('üñ•Ô∏è Affichage question c√¥t√© h√¥te');
            showScreen('hostQuestionScreen');
            
            // R√©cup√©rer et afficher la question
            database.ref(`games/${currentGameId}/currentQuestion`).once('value', (snapshot) => {
                const question = snapshot.val();
                if (question) {
                    document.getElementById('hostQuestionText').textContent = question.question;
                    
                    const optionsGrid = document.getElementById('hostOptionsGrid');
                    optionsGrid.innerHTML = '';
                    
                    question.options.forEach((option, index) => {
                        const btn = document.createElement('div');
                        btn.className = 'option-btn';
                        btn.textContent = option;
                        if (index === question.correct) {
                            btn.classList.add('correct');
                        }
                        optionsGrid.appendChild(btn);
                    });
                }
            });

            // Fonction pour compter les r√©ponses
            function updateAnswerCount() {
                database.ref(`games/${currentGameId}/players`).once('value', (snapshot) => {
                    const players = snapshot.val() || {};
                    database.ref(`games/${currentGameId}/currentQuestionIndex`).once('value', (indexSnapshot) => {
                        const currentIndex = indexSnapshot.val() || 0;
                        
                        let totalPlayers = 0;
                        let answeredPlayers = 0;
                        
                        Object.values(players).forEach(player => {
                            totalPlayers++;
                            if (player.answers && player.answers[currentIndex] !== undefined) {
                                answeredPlayers++;
                            }
                        });
                        
                        const answerCountElement = document.getElementById('hostAnswersCount');
                        answerCountElement.textContent = `${answeredPlayers}/${totalPlayers} joueurs ont r√©pondu`;
                        
                        console.log(`üìä R√©ponses: ${answeredPlayers}/${totalPlayers}`);
                        
                        // Auto-passer si tous ont r√©pondu
                        if (answeredPlayers === totalPlayers && totalPlayers > 0) {
                            console.log('‚úÖ Tous les joueurs ont r√©pondu, passage automatique');
                            setTimeout(() => {
                                if (timer) {
                                    clearInterval(timer);
                                    timer = null;
                                }
                                skipQuestion();
                            }, 1000);
                        }
                    });
                });
            }
            
            // √âcouter les changements de r√©ponses EN TEMPS R√âEL
            const answerListener = database.ref(`games/${currentGameId}/players`).on('value', updateAnswerCount);
            questionListeners.push(answerListener);
            
            // Compter initialement
            updateAnswerCount();
        }

        // Afficher la question c√¥t√© joueur
        function displayPlayerQuestion(question) {
            console.log('üì± Affichage question c√¥t√© joueur:', question.question);
            document.getElementById('playerQuestionText').textContent = question.question;
            
            const optionsGrid = document.getElementById('playerOptionsGrid');
            optionsGrid.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option;
                btn.onclick = () => selectAnswer(index);
                optionsGrid.appendChild(btn);
            });

            document.getElementById('playerSelectedAnswer').style.display = 'none';
        }

        // S√©lectionner une r√©ponse (joueur)
        async function selectAnswer(answerIndex) {
            try {
                console.log(`üìù Joueur ${currentPlayerId} r√©pond: ${answerIndex}`);
                
                // R√©cup√©rer l'index de la question actuelle
                const indexSnapshot = await database.ref(`games/${currentGameId}/currentQuestionIndex`).once('value');
                const currentIndex = indexSnapshot.val() || 0;
                
                console.log(`üìä Question actuelle: ${currentIndex}`);
                
                // Sauvegarder la r√©ponse
                await database.ref(`games/${currentGameId}/players/${currentPlayerId}/answers/${currentIndex}`).set(answerIndex);
                
                console.log(`‚úÖ R√©ponse sauvegard√©e: joueur ${currentPlayerId}, question ${currentIndex}, r√©ponse ${answerIndex}`);
                
                // Marquer visuellement la r√©ponse
                document.querySelectorAll('#playerOptionsGrid .option-btn').forEach((btn, index) => {
                    btn.classList.remove('selected');
                    if (index === answerIndex) {
                        btn.classList.add('selected');
                    }
                    btn.disabled = true;
                });
                
                document.getElementById('playerSelectedAnswer').style.display = 'block';
                
                // V√©rifier dans la base de donn√©es
                const checkSnapshot = await database.ref(`games/${currentGameId}/players/${currentPlayerId}/answers/${currentIndex}`).once('value');
                console.log(`üîç V√©rification sauvegarde: ${checkSnapshot.val()}`);
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'envoi de la r√©ponse:', error);
                alert('Erreur lors de l\'envoi de votre r√©ponse. Veuillez r√©essayer.');
            }
        }

        // Passer √† la question suivante ou aux r√©sultats
        async function skipQuestion() {
            console.log('‚è≠Ô∏è Passage √† la question suivante...');
            
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            try {
                await database.ref(`games/${currentGameId}/gameState`).set('results');
                await calculateScores();
                console.log('‚úÖ Scores calcul√©s, affichage des r√©sultats');
            } catch (error) {
                console.error('‚ùå Erreur lors du passage √† la question suivante:', error);
            }
        }

        // Calculer les scores
        async function calculateScores() {
            console.log('üßÆ Calcul des scores...');
            const snapshot = await database.ref(`games/${currentGameId}/players`).once('value');
            const players = snapshot.val() || {};
            const currentIndex = await getCurrentQuestionIndex();
            const correctAnswer = questions[currentIndex].correct;
            
            console.log(`‚úÖ Bonne r√©ponse: ${correctAnswer}`);
            
            Object.keys(players).forEach(playerId => {
                const player = players[playerId];
                const answer = player.answers && player.answers[currentIndex];
                
                if (answer === correctAnswer) {
                    player.score = (player.score || 0) + 10;
                    console.log(`‚úÖ ${player.name} a bien r√©pondu (+10 points)`);
                } else {
                    console.log(`‚ùå ${player.name} a mal r√©pondu`);
                }
            });

            await database.ref(`games/${currentGameId}/players`).set(players);
            console.log('üíæ Scores sauvegard√©s');
        }

        // Afficher les r√©sultats c√¥t√© h√¥te
        async function showHostResults() {
            console.log('üìä Affichage r√©sultats c√¥t√© h√¥te');
            showScreen('hostResultsScreen');
            
            const currentIndex = await getCurrentQuestionIndex();
            const question = questions[currentIndex];
            const correctAnswer = question.options[question.correct];
            
            document.getElementById('hostCorrectAnswer').innerHTML = 
                `<h3>‚úÖ Bonne r√©ponse : ${correctAnswer}</h3>`;
            
            // Afficher le classement
            const snapshot = await database.ref(`games/${currentGameId}/players`).once('value');
            const players = snapshot.val() || {};
            const sortedPlayers = Object.values(players).sort((a, b) => (b.score || 0) - (a.score || 0));
            
            const scoreBoard = document.getElementById('hostScoreBoard');
            scoreBoard.innerHTML = '<h3>üèÜ Classement actuel :</h3>';
            
            sortedPlayers.forEach((player, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                scoreItem.innerHTML = `
                    <span>${index + 1}. ${player.name}</span>
                    <span>${player.score || 0} pts</span>
                `;
                scoreBoard.appendChild(scoreItem);
            });
            
            // Timer pour la question suivante
            let nextTimer = 5;
            const timerElement = document.getElementById('hostNextTimer');
            const interval = setInterval(() => {
                timerElement.textContent = nextTimer;
                nextTimer--;
                
                if (nextTimer < 0) {
                    clearInterval(interval);
                    nextQuestion();
                }
            }, 1000);
        }

        // Afficher les r√©sultats c√¥t√© joueur
        async function showPlayerResults() {
            console.log('üì± Affichage r√©sultats c√¥t√© joueur');
            showScreen('playerResultsScreen');
            
            const currentIndex = await getCurrentQuestionIndex();
            const question = questions[currentIndex];
            const correctAnswer = question.correct;
            
            // V√©rifier la r√©ponse du joueur
            const playerSnapshot = await database.ref(`games/${currentGameId}/players/${currentPlayerId}`).once('value');
            const playerData = playerSnapshot.val();
            const playerAnswer = playerData.answers && playerData.answers[currentIndex];
            
            let resultHTML;
            if (playerAnswer === correctAnswer) {
                resultHTML = `
                    <div style="color: #00b894; font-size: 1.2rem;">
                        ‚úÖ Bonne r√©ponse ! (+10 points)
                    </div>
                `;
            } else {
                resultHTML = `
                    <div style="color: #ff6b6b; font-size: 1.2rem;">
                        ‚ùå Mauvaise r√©ponse
                    </div>
                    <div>La bonne r√©ponse √©tait : <strong>${question.options[correctAnswer]}</strong></div>
                `;
            }
            
            document.getElementById('playerAnswerResult').innerHTML = resultHTML;
            document.getElementById('playerCurrentScore').innerHTML = 
                `<div style="font-size: 1.1rem; margin-top: 1rem;">Votre score : <strong>${playerData.score || 0} points</strong></div>`;
            
            // Timer pour la question suivante
            let nextTimer = 5;
            const timerElement = document.getElementById('playerNextTimer');
            const interval = setInterval(() => {
                timerElement.textContent = nextTimer;
                nextTimer--;
                
                if (nextTimer < 0) {
                    clearInterval(interval);
                }
            }, 1000);
        }

        // Passer √† la question suivante
        async function nextQuestion() {
            console.log('‚û°Ô∏è Passage √† la question suivante');
            const currentIndex = await getCurrentQuestionIndex();
            const nextIndex = currentIndex + 1;
            
            if (nextIndex >= questions.length) {
                console.log('üèÅ Fin du quiz');
                await database.ref(`games/${currentGameId}/gameState`).set('finished');
            } else {
                await database.ref(`games/${currentGameId}/currentQuestionIndex`).set(nextIndex);
                await database.ref(`games/${currentGameId}/gameState`).set('question');
                await showNextQuestion();
            }
        }

        // Afficher les r√©sultats finaux c√¥t√© h√¥te
        async function showHostFinalResults() {
            console.log('üèÜ Affichage r√©sultats finaux c√¥t√© h√¥te');
            showScreen('hostFinalScreen');
            
            const snapshot = await database.ref(`games/${currentGameId}/players`).once('value');
            const players = snapshot.val() || {};
            const sortedPlayers = Object.values(players).sort((a, b) => (b.score || 0) - (a.score || 0));
            
            const scoreBoard = document.getElementById('hostFinalScoreBoard');
            scoreBoard.innerHTML = '';
            
            sortedPlayers.forEach((player, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                let medal = '';
                if (index === 0) medal = 'ü•á';
                else if (index === 1) medal = 'ü•à';
                else if (index === 2) medal = 'ü•â';
                
                scoreItem.innerHTML = `
                    <span>${medal} ${index + 1}. ${player.name}</span>
                    <span>${player.score || 0} pts</span>
                `;
                scoreBoard.appendChild(scoreItem);
            });
        }

        // Afficher les r√©sultats finaux c√¥t√© joueur
        async function showPlayerFinalResults() {
            console.log('üèÅ Affichage r√©sultats finaux c√¥t√© joueur');
            showScreen('playerFinalScreen');
            
            const snapshot = await database.ref(`games/${currentGameId}/players`).once('value');
            const players = snapshot.val() || {};
            const sortedPlayers = Object.values(players).sort((a, b) => (b.score || 0) - (a.score || 0));
            
            // Trouver la position du joueur
            const playerIndex = sortedPlayers.findIndex(p => p.id === currentPlayerId);
            const playerScore = sortedPlayers[playerIndex]?.score || 0;
            
            let resultMessage = '';
            if (playerIndex === 0) {
                resultMessage = 'ü•á F√©licitations ! Vous avez gagn√© !';
            } else if (playerIndex === 1) {
                resultMessage = 'ü•à Excellent ! Vous √™tes deuxi√®me !';
            } else if (playerIndex === 2) {
                resultMessage = 'ü•â Bravo ! Vous √™tes troisi√®me !';
            } else {
                resultMessage = `Vous √™tes ${playerIndex + 1}${playerIndex === 0 ? 'er' : '√®me'} !`;
            }
            
            document.getElementById('playerFinalResult').innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem;">${resultMessage}</div>
                <div style="font-size: 1.1rem;">Votre score final : <strong>${playerScore} points</strong></div>
            `;
            
            // Afficher le classement complet
            const scoreBoard = document.getElementById('playerFinalScoreBoard');
            scoreBoard.innerHTML = '<h3>üèÜ Classement final :</h3>';
            
            sortedPlayers.forEach((player, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                let medal = '';
                if (index === 0) medal = 'ü•á';
                else if (index === 1) medal = 'ü•à';
                else if (index === 2) medal = 'ü•â';
                
                // Mettre en √©vidence le joueur actuel
                if (player.id === currentPlayerId) {
                    scoreItem.style.background = 'rgba(255, 107, 107, 0.3)';
                    scoreItem.style.border = '2px solid #ff6b6b';
                }
                
                scoreItem.innerHTML = `
                    <span>${medal} ${index + 1}. ${player.name}</span>
                    <span>${player.score || 0} pts</span>
                `;
                scoreBoard.appendChild(scoreItem);
            });
        }

        // Timer
        function startTimer() {
            if (timer) {
                clearInterval(timer);
            }
            
            timeLeft = 30;
            const hostTimerEl = document.getElementById('hostTimer');
            const playerTimerEl = document.getElementById('playerTimer');
            
            console.log('‚è∞ Timer d√©marr√©: 30 secondes');
            
            if (hostTimerEl) hostTimerEl.textContent = timeLeft;
            if (playerTimerEl) playerTimerEl.textContent = timeLeft;
            
            timer = setInterval(() => {
                timeLeft--;
                
                if (hostTimerEl) hostTimerEl.textContent = timeLeft;
                if (playerTimerEl) playerTimerEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    console.log('‚è∞ Temps √©coul√© !');
                    clearInterval(timer);
                    timer = null;
                    if (isHost) {
                        skipQuestion();
                    }
                }
            }, 1000);
        }

        // Utilitaires
        async function getCurrentQuestionIndex() {
            const snapshot = await database.ref(`games/${currentGameId}/currentQuestionIndex`).once('value');
            return snapshot.val() || 0;
        }

        function updatePlayersList(players) {
            const playersList = document.getElementById('playersList');
            
            if (Object.keys(players).length === 0) {
                playersList.innerHTML = '<p style="opacity: 0.7;">En attente des joueurs...</p>';
                return;
            }
            
            playersList.innerHTML = '';
            Object.values(players).forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                playerItem.innerHTML = `
                    <span>üë§ ${player.name}</span>
                    <span>${player.score || 0} pts</span>
                `;
                playersList.appendChild(playerItem);
            });
        }

        function showLoading(loadingId, textId) {
            document.getElementById(loadingId).style.display = 'inline-block';
            document.getElementById(textId).style.display = 'none';
        }

        function hideLoading(loadingId, textId) {
            document.getElementById(loadingId).style.display = 'none';
            document.getElementById(textId).style.display = 'inline';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showJoinError(message) {
            const errorDiv = document.getElementById('joinError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Fonctions de debug
        function debugGameState() {
            console.log('üîç === DEBUG √âTAT DU JEU ===');
            console.log('Game ID:', currentGameId);
            console.log('Is Host:', isHost);
            console.log('Player ID:', currentPlayerId);
            
            if (currentGameId) {
                database.ref(`games/${currentGameId}`).once('value', (snapshot) => {
                    const gameData = snapshot.val();
                    console.log('üìä Donn√©es du jeu:', gameData);
                    
                    if (gameData && gameData.players) {
                        Object.entries(gameData.players).forEach(([playerId, player]) => {
                            console.log(`üë§ Joueur ${playerId}:`, player);
                            if (player.answers) {
                                console.log(`üìù R√©ponses:`, player.answers);
                            }
                        });
                    }
                });
            }
        }

        function forceNextQuestion() {
            console.log('üöÄ Passage forc√© √† la question suivante');
            skipQuestion();
        }

        function endGameSession() {
            if (currentGameId) {
                database.ref(`games/${currentGameId}`).remove();
            }
            cleanupGame();
            showHome();
        }

        function cleanupGame() {
            if (currentGameId) {
                database.ref(`games/${currentGameId}`).off();
            }
            
            // Nettoyer les listeners de questions
            questionListeners.forEach(listener => {
                if (listener) {
                    database.ref(`games/${currentGameId}/players`).off('value', listener);
                }
            });
            questionListeners = [];
            
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            currentGameId = null;
            currentPlayerId = null;
            isHost = false;
            questions = [];
        }

        // Gestion des param√®tres URL (pour le QR code)
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameParam = urlParams.get('game');
            
            if (gameParam) {
                document.getElementById('gameIdInput').value = gameParam;
                showJoinGame();
            }
        });

        // Gestion de la fermeture de la page
        window.addEventListener('beforeunload', () => {
            if (currentGameId && currentPlayerId && !isHost) {
                database.ref(`games/${currentGameId}/players/${currentPlayerId}`).remove();
            }
        });

        // Auto-focus sur les champs de saisie
        document.getElementById('gameIdInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Permettre d'appuyer sur Entr√©e pour rejoindre
        document.getElementById('playerNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinGame();
            }
        });

        document.getElementById('gameIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('playerNameInput').focus();
            }
        });

        // Log de d√©marrage
        console.log('üéÆ Quiz des Capitales - Version Firebase');
        console.log('üî• Firebase initialis√©');
        console.log('üìç URL:', window.location.href);
    </script>
</body>
</html>